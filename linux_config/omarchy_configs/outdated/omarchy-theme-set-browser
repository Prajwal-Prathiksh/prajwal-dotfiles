#!/bin/bash

CHROMIUM_THEME=~/.config/omarchy/current/theme/chromium.theme

if omarchy-cmd-present chromium || omarchy-cmd-present helium-browser || omarchy-cmd-present brave; then
  if [[ -f $CHROMIUM_THEME ]]; then
    THEME_RGB_COLOR=$(<$CHROMIUM_THEME)
    THEME_HEX_COLOR=$(printf '#%02x%02x%02x' ${THEME_RGB_COLOR//,/ })
  else
    # Use a default, neutral grey if theme doesn't have a color
    THEME_RGB_COLOR="28,32,39"
    THEME_HEX_COLOR="#1c2027"
  fi

  if omarchy-cmd-present chromium; then
    rm -f /etc/chromium/policies/managed/color.json

    # Apply theme to all Chromium profiles
    CHROMIUM_DIR=~/.config/chromium

    # Find all profile directories (Default, Profile 1, Profile 2, etc.)
    for profile_dir in "$CHROMIUM_DIR"/Default "$CHROMIUM_DIR"/Profile*; do
      if [[ -d "$profile_dir" ]]; then
        profile_name=$(basename "$profile_dir")

        # Apply theme color for this profile
        chromium --no-startup-window --profile-directory="$profile_name" --set-theme-color="$THEME_RGB_COLOR"

        # Apply color scheme (light/dark) for this profile
        if [[ -f ~/.config/omarchy/current/theme/light.mode ]]; then
          chromium --no-startup-window --profile-directory="$profile_name" --set-color-scheme="light"
        else
          chromium --no-startup-window --profile-directory="$profile_name" --set-color-scheme="dark"
        fi
      fi
    done
  fi

  if omarchy-cmd-present brave; then
    echo "{\"BrowserThemeColor\": \"$THEME_HEX_COLOR\"}" | tee "/etc/brave/policies/managed/color.json" >/dev/null
    brave --refresh-platform-policy --no-startup-window
  fi
fi
